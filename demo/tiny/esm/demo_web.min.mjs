const t=t=>new Promise(e=>setTimeout(e,t));function e(){let t=e.id;if(!t){if(t=Math.random().toString(36).slice(2),"undefined"!=typeof sessionStorage){let e="u8-mqtt-demo sess_id",n=sessionStorage.getItem(e);n?t=n:sessionStorage.setItem(e,t)}e.id=t}return t}function n(t,e=[]){do{const n=127&t;t>>>=7,e.push(n|(0===t?0:128))}while(t>0);return e}function s(t,e=0){let n=(127&t[e])<<0;return 128&t[e++]&&(n|=(127&t[e])<<7,128&t[e++]&&(n|=(127&t[e])<<14,128&t[e++]&&(n|=(127&t[e])<<21))),[n,e]}function r(t){let e=new Uint8Array(0);return n=>{e=0===e.byteLength?n:function(t,e){const n=t.byteLength,s=new Uint8Array(n+e.byteLength);return s.set(t,0),s.set(e,n),s}(e,n);const r=[];for(;;){const[n,o]=s(e,1),i=n+o;if(e.byteLength<i)return r;let u=e[0],a=0===n?null:e.subarray(o,i);e=e.subarray(i);const c=t(u,a);null!=c&&r.push(c)}}}const o=new Map;{const t=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qo_s"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]];for(const[e,n,s,r]of t){const t={id:e,type:n,name:s};r&&(t.plural=r),o.set(t.id,t),o.set(t.name,t)}}const i=t=>new TextDecoder("utf-8").decode(t),u=t=>(e,n)=>(n=t,t+=e,n);class a{constructor(t,e=0){this.buf=t,this.step=u(e)}_fork(t,e){return{__proto__:this,buf:t,step:u(e)}}has_more(){const{buf:t,step:e}=this;return t.byteLength>e(0)}u8(){const{buf:t,step:e}=this;return t[e(1)]}u16(){const{buf:t,step:e}=this,n=e(2);return t[n]<<8|t[n+1]}u32(){const{buf:t,step:e}=this,n=e(4);return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}vint(){const{buf:t,step:e}=this,[n,r]=s(t,e(0));return e(r),n}bin(){const{buf:t,step:e}=this,n=e(2),s=t[n]<<8|t[n+1],r=e(s);return t.subarray(r,r+s)}utf8(){return i(this.bin())}pair(){return[i(this.bin()),i(this.bin())]}u8_flags(t){const{buf:e,step:n}=this;return new t(e[n(1)])}u8_reason(t){const{buf:e,step:n}=this;return t(e[n(1)])}flush(){const{buf:t,step:e}=this;return this.step=this.buf=null,t.subarray(e(0))}props(){const{buf:t,step:e}=this,[n,r]=s(t,e(0));e(n+1);const i=r+n;if(0===n)return null;const u=[],a=this._fork(t.subarray(r,i),0);for(;a.has_more();){let t=a.u8();const{name:e,type:n}=o.get(t),s=a[n]();u.push([e,s])}return u}}class c extends Number{constructor(t,e){super(t),this.reason=e}}function p(t){const e=new Map;for(const[n,s]of t)e.set(n,new c(n,s));return e.get.bind(e)}const l=t=>[t>>>8&255,255&t];class f{constructor(){this._pkt_writer(this)}as_pkt(t){return this.pack([t])}u8(t){this.push([255&t])}u16(t){this.push(l(t))}u32(t){this.push((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])(t))}vint(t){this.push(n(t))}_u16_bin(t){const{push:e}=this;e(l(t.byteLength)),e(t)}flush(t){var e;null!=t&&this.push("string"==typeof t?(e=t,new TextEncoder("utf-8").encode(e)):t),this.push=!1}bin(t){return t?"string"==typeof t?this.utf8(t):(t.length!==t.byteLength&&(t=new Uint8Array(t)),void this._u16_bin(t)):this.u16(0)}utf8(t){this._u16_bin(new TextEncoder("utf-8").encode(t))}pair(t,e){this.utf8(t),this.utf8(e)}u8_flags(t,e,n=0){return void 0!==t&&isNaN(+t)&&(t=e(t,0)),t|=n,this.push([t]),t}u8_reason(t){this.push([0|t])}props(t){if(!t)return this.u8(0);if(Array.isArray(t)){if(0===t.length)return this.u8(0)}else t=t.entries?Array.from(t.entries()):Object.entries(t);const e=this._fork();for(const[n,s]of t){const{id:t,type:r}=o.get(n);e.u8(t),e[r](s)}this.push(e.pack([]))}_fork(){let t={__proto__:this};return this._pkt_writer(t),t}}f.prototype._pkt_writer=function(){const t=[];return e=>0===t.length?function(t,e){let s=0,r=[];return o(t);function o(e){(t=e).push=i,t.pack=u}function i(t){r.push(t),s+=t.length}function u(i){t=t.push=t.pack=null;const u=function(t,e,s){const r=n(e,t);let o=r.length;const i=new Uint8Array(e+o);i.set(r,0);for(const t of s)i.set(t,o),o+=t.length;return i}(i,s,r);return s=0,r=[],void 0!==e&&e.push(o),u}}(e,t):t.pop()(e)}();const _=new Uint8Array([0,4,77,81,84,84]);const d=["reserved","connect","connack","publish","puback","pubrec","pubrel","pubcomp","subscribe","suback","unsubscribe","unsuback","pingreq","pingresp","disconnect","auth"],h=t=>Object.defineProperties(t||{},{hdr:{get(){return 15&this.b0}},id:{get(){return this.b0>>>4}},type:{get(){return d[this.b0>>>4]}}});const b=(w=[function(t){const e=t=>0|(t.reserved?1:0)|(3&t.will_qos)<<3|(t.clean_start?2:0)|(t.will_flag?4:0)|(t.will_retain?32:0)|(t.password?64:0)|(t.username?128:0);return t.connect=(t,n)=>{const s=new f;s.push(_),s.u8(t);const{will:r,username:o,password:i}=n,u=s.u8_flags(n.flags,e,0|(o?128:0)|(i?64:0)|(r?(t=>4|(3&t.qos)<<3|(t.retain?32:0))(r):0));return s.u16(n.keep_alive),5<=t&&s.props(n.props),s.utf8(n.client_id),4&u&&(5<=t&&s.props(r.props),s.utf8(r.topic),s.bin(r.payload)),128&u&&s.utf8(o),64&u&&s.bin(i),s.as_pkt(16)}},function(t){return t.disconnect=(t,e)=>{const n=new f;return 5<=t&&(e.reason||e.props)&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(224)}},function(t){return t.publish=(t,e)=>{const n=(3&e.qos)<<1,s=new f;return s.utf8(e.topic),0!==n&&s.u16(e.pkt_id),5<=t?(s.props(e.props),s.flush(e.payload)):s.flush(e.payload),s.as_pkt(48|n|(e.dup?8:0)|(e.retain?1:0))}},function(t){return t.puback=(t,e)=>{const n=new f;return n.u16(e.pkt_id),5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(64)}},function(t){const e=t=>0|3&t.qos|(t.retain?4:0)|(3&t.retain_handling)<<2;return t.subscribe=(t,n)=>{const s=new f;s.u16(n.pkt_id),5<=n.mqtt_level&&s.props(n.props);const r=e(n);for(const t of n.topics)"string"==typeof t?(s.utf8(t),s.u8(r)):Array.isArray(t)?(s.utf8(t[0]),void 0!==t[1]?s.u8_flags(t[1],e):s.u8(r)):(s.utf8(t.topic),void 0!==t.opts?s.u8_flags(t.opts,e):s.u8(r));return s.as_pkt(130)}}],m=function(t){const e=[];for(const n of t)n(e);return t=>r((n,s)=>{const r=e[n>>>4]||e[0];if(void 0!==r)return r({__proto__:t,b0:n},s)})}(m=[function(t){class e extends Number{get session_present(){return!0&this}}const n=p([[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"]]);return t[2]=(t,s)=>{const r=new a(s,0);return t.flags=r.u8_flags(e),t.reason=r.u8_reason(n),5<=t.mqtt_level&&(t.props=r.props()),t}},function(t){const e=p([[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);return t[9]=(n=e,(t,e)=>{const s=new a(e,0);t.pkt_id=s.u16(),5<=t.mqtt_level&&(t.props=s.props());const r=t.answers=[];for(;s.has_more();)r.push(s.u8_reason(n));return t});var n},function(t){return t[3]=(t,e)=>{const{hdr:n}=t;t.dup=Boolean(8&n),t.retain=Boolean(1&n);const s=t.qos=n>>1&3,r=new a(e,0);return t.topic=r.utf8(),0!==s&&(t.pkt_id=r.u16()),5<=t.mqtt_level&&(t.props=r.props()),t.payload=r.flush(),t}},function(t){const e=p([[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"]]);return t[4]=(t,n)=>{const s=new a(n,0);return t.pkt_id=s.u16(),5<=t.mqtt_level&&(t.reason=s.u8_reason(e),t.props=s.props()),t}}]),w=function(t){const e={};for(const n of t)n(e);return({mqtt_level:t})=>(n,s)=>e[n](t,s)}(w),y=h(y),t=>e=>[m(e=e||{__proto__:y,mqtt_level:t,get _base_(){return e}}),w(e),e])(4);var m,w,y;function v(){const t=[];return t.then=e=>{t.push(e)},t.notify=e=>{for(const n of t.splice(0,t.length))n(e)},t}class g extends class extends class{constructor(t={}){"function"==typeof t&&(t={on_mqtt:t});const{on_mqtt:e,on_live:n}=t;e&&(this.on_mqtt=e),n&&(this.on_live=n),this._conn_=function(t){const e=v(),n=v(),s=async(t,e)=>(await n)(t,e);let r=t._send=s;return{is_live:()=>s!==r,reset(){t._send=r=s},async send_connect(...o){s===r&&(r=await e);let i=r(...o);return await null,t._send=r,n.notify(r),i},set(n,s){const[o,i]=n();return r=async(t,e)=>s(i(t,e)),e.notify(r),async function(t){await 0,t.on_live(t)}(t),e=>t.on_mqtt(o(e),{mqtt:t})}}}(this),this.on_mqtt([],{mqtt:this})}auth(t){return this._send("auth",t)}connect(t){return this._conn_.send_connect("connect",t)}disconnect(t){return this._send("disconnect",t)}ping(){return this._send("pingreq")}subscribe(t){return this._send("subscribe",t)}unsubscribe(t){return this._send("unsubscribe",t)}puback(t){return this._send("puback",t)}publish(t){return this._send("publish",t)}on_mqtt(){}on_live(){}}{with_websock(t){null==t&&(t="ws://127.0.0.1:9001"),("string"==typeof t||t.origin)&&(t=new WebSocket(new URL(t),["mqtt"])),t.binaryType="arraybuffer";let e=!0,{readyState:n}=t;if(1!==n){if(0!==n)throw new Error("Invalid WebSocket readyState");e=new Promise(e=>t.addEventListener("open",e,{once:!0}))}const{_conn_:s}=this,r=s.set(this.mqtt_session,async n=>(await e,t.send(n)));return t.addEventListener("close",()=>{delete t.onmessage,s.reset()},{once:!0}),t.onmessage=t=>r(new Uint8Array(t.data)),this}}{}g.with(b),(window.my_mqtt=new g((function(t,{mqtt:e}){for(const e of t){const{type:t,...n}=e;console.log(`%c[mqtt ${t}]: %o`,"color: blue",n)}})).with_websock("wss://test.mosquitto.org:8081")).on_live=async function(n){await async function(n){const s=e();await t(10),n.connect({keep_alive:60,client_id:`u8-mqtt-packet-${s}-`,flags:{clean_start:!0}}),await t(10),n.subscribe({pkt_id:10,topics:["u8-mqtt-packet/+"]}),await t(10),n.publish({topic:"u8-mqtt-packet/test-topic",payload:"awesome from node or web"}),await t(10),n.publish({topic:"u8-mqtt-packet/hello-from/"+s,payload:"Hello from "+s})}(n),await t(10),n.disconnect()};
