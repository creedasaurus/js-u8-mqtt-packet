const t=t=>new Promise(e=>setTimeout(e,t));function e(){let t=e.res;if(!t&&(t=Math.random().toString(36).slice(2),"undefined"!=typeof sessionStorage)){let e="u8-mqtt-demo sess_id";t=sessionStorage.get(e)}return t}const[n,s]=(()=>{const t=[[0,"reserved"],[1,"connect"],[2,"connack"],[3,"publish"],[4,"puback"],[5,"pubrec"],[6,"pubrel"],[7,"pubcomp"],[8,"subscribe"],[9,"suback"],[10,"unsubscribe"],[11,"unsuback"],[12,"pingreq"],[13,"pingresp"],[14,"disconnect"],[15,"auth"]],e=new Map;for(const[n,s]of t){const t=n<<4;e.set(t,{type:s,cmd:t,id:n})}return[e.get.bind(e),Array.from(e.values())]})(),[r,o]=(()=>{const t=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qo_s"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]],e=new Map;for(const[n,s,r,o]of t){const t={id:n,type:s,name:r};o&&(t.plural=o),e.set(t.id,t),e.set(t.name,t)}return[e.get.bind(e),Array.from(e.values())]})();function i(t,e=[]){do{const n=127&t;t>>>=7,e.push(n|(0===t?0:128))}while(t>0);return e}function u(t,e=0,n=[]){let s=(127&t[e])<<0;return 128&t[e++]&&(s|=(127&t[e])<<7,128&t[e++]&&(s|=(127&t[e])<<14,128&t[e++]&&(s|=(127&t[e])<<21))),n[0]=s,n[1]=e,n}const a=t=>new TextDecoder("utf-8").decode(t),c=t=>(e,n)=>(n=t,t+=e,n);class p{constructor(t,e=0){this.buf=t,this.step=c(e)}_fork(t,e){return{__proto__:this,buf:t,step:c(e)}}has_more(){const{buf:t,step:e}=this;return t.byteLength>e(0)}u8(){const{buf:t,step:e}=this;return t[e(1)]}u16(){const{buf:t,step:e}=this,n=e(2);return t[n]<<8|t[n+1]}u32(){const{buf:t,step:e}=this,n=e(4);return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}vint(){const{buf:t,step:e}=this,[n,s]=u(t,e(0));return e(s),n}bin(){const{buf:t,step:e}=this,n=e(2),s=t[n]<<8|t[n+1],r=e(s);return t.subarray(r,r+s)}utf8(){return a(this.bin())}pair(){return[a(this.bin()),a(this.bin())]}u8_flags(t){const{buf:e,step:n}=this;return new t(e[n(1)])}u8_reason(t){const{buf:e,step:n}=this;return t(e[n(1)])}flush(){const{buf:t,step:e}=this;return this.step=this.buf=null,t.subarray(e(0))}props(){const{buf:t,step:e}=this,[n,s]=u(t,e(0)),o=s+n;if(e(o),0===n)return null;const i=[],a=this._fork(t.subarray(s,o));for(;a.has_more();){const{name:t,type:e}=r(a.u8()),n=a[e]();i.push([t,n])}return i}}class d extends Number{constructor(t,e){super(t),this.reason=e}}function l(t){const e=new Map;for(const[n,s]of t)e.set(n,new d(n,s));return e.get.bind(e)}function f(t,e){const[s]=t,[r,o]=u(s,1),i=r+o;if(s.byteLength>=i){const u=s[0],a=240&u;return t[0]=s.subarray(i),{__proto__:e,b0:u,cmd:a,id:u>>>4,hdr:15&u,type_obj:n(a),u8_body:0===r?null:s.subarray(o,i)}}}function _(t){return e=>{if(e!==e._base_)throw"_pkt_ctx_._base_";const n=[new Uint8Array(0)];return s=>{n[0]=0===n[0].byteLength?s:function(t,e){const n=t.byteLength,s=new Uint8Array(n+e.byteLength);return s.set(t,0),s.set(e,n),s}(n[0],s);const r=[];for(;;){const s=f(n,e);if(void 0===s)return r;r.push(t(s))}}}}const h=t=>[t>>>8&255,255&t];class b{constructor(){this._pkt_writer(this)}as_pkt(t){return this.pack([t])}u8(t){this.push([255&t])}u16(t){this.push(h(t))}u32(t){this.push((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])(t))}vint(t){this.push(i(t))}_u16_bin(t){const{push:e}=this;e(h(t.byteLength)),e(t)}flush(t){var e;null!=t&&this.push("string"==typeof t?(e=t,new TextEncoder("utf-8").encode(e)):t),this.push=!1}bin(t){return t?"string"==typeof t?this.utf8(t):(t.length!==t.byteLength&&(t=new Uint8Array(t)),void this._u16_bin(t)):this.u16(0)}utf8(t){this._u16_bin(new TextEncoder("utf-8").encode(t))}pair(t,e){this.utf8(t),this.utf8(e)}u8_flags(t,e,n=0){return void 0!==t&&isNaN(+t)&&(t=e(t,0)),t|=n,this.push([t]),t}u8_reason(t){this.push([0|t])}props(t){if(!t)return this.u8(0);Array.isArray(t)||(t=t.entries?Array.from(t.entries()):Object.entries(t));const e=this._fork();for(const[n,s]of t){const{id:t,type:o}=r(n);e.u8(t),e[o](s)}this.push(e.pack([]))}}b.prototype._pkt_writer=function(){const t=[];return e=>0===t.length?function(t,e){let n=0,s=[];return r(t);function r(e){(t=e).push=o,t.pack=u}function o(t){s.push(t),n+=t.length}function u(o){t=t.push=t.pack=null;const u=function(t,e,n){const s=i(e,t);let r=s.length;const o=new Uint8Array(e+r);o.set(s,0);for(const t of n)o.set(t,r),r+=t.length;return o}(o,n,s);return n=0,s=[],void 0!==e&&e.push(r),u}}(e,t):t.pop()(e)}();const m=new Uint8Array([0,4,77,81,84,84]);const y=t=>0|(t.reserved?1:0)|(3&t.will_qos)<<3|(t.clean_start?2:0)|(t.will_flag?4:0)|(t.will_retain?32:0)|(t.password?64:0)|(t.username?128:0),v=t=>4|(3&t.qos)<<3|(t.retain?32:0);const w=t=>0|3&t.qos|(t.retain?4:0)|(3&t.retain_handling)<<2;class g extends Number{get session_present(){return!0&this}}const k=l([[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"]]);l([[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"]]),l([[0,"Success"],[146,"Packet Identifier not found"]]);const S=l([[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);l([[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"]]),l([[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]),l([[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"]]);const q=Array(17).fill(t=>t);q[2]=function(t){const e=new p(t.u8_body,0);return t.flags=e.u8_flags(g),t.reason=e.u8_reason(k),5<=t.mqtt_level&&(t.props=e.props()),t},q[3]=function(t){const{hdr:e}=t;t.dup=Boolean(8&e),t.retain=Boolean(1&e);const n=t.qos=e>>1&3,s=new p(t.u8_body,0);return t.topic=s.utf8(),0!==n&&(t.pkt_id=s.u16()),5<=t.mqtt_level?(t.props=s.props(),t.payload=s.flush()):t.payload=s.flush(),t},q[9]=function(t){return function(t,e){const n=new p(t.u8_body,0);t.pkt_id=n.u16(),5<=t.mqtt_level&&(t.props=n.props());const s=t.answers=[];for(;n.has_more();)s.push(n.u8_reason(e));return t}(t,S)};const x=(A=q,_(t=>{const e=A[t.type_obj.id];return void 0!==e?e.call(A,t):A[0](t)}));var A;const P=(N={connect:function(t,e){const n=new b;n.push(m),n.u8(t);const{will:s}=e,r=n.u8_flags(e.flags,y,s?v(s):0);return n.u16(e.keep_alive),5<=t&&n.props(e.props),n.utf8(e.client_id),4&r&&(5<=t&&n.props(s.properties),n.utf8(s.topic),n.bin(s.payload)),128&r&&n.utf8(e.username),64&r&&n.bin(e.password),n.as_pkt(16)},disconnect:function(t,e){const n=new b;return 5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(224)},publish:function(t,e){const n=(3&e.qos)<<1,s=new b;return s.utf8(e.topic),0!==n&&s.u16(e.pkt_id),5<=t?(s.props(e.props),s.flush(e.payload)):s.flush(e.payload),s.as_pkt(48|n|(e.dup?8:0)|(e.retain?1:0))},subscribe:function(t,e){const n=new b;n.u16(e.pkt_id),5<=e.mqtt_level&&n.props(e.props);const s=w(e);for(const t of e.topics)"string"==typeof t?(n.utf8(t),n.u8(s)):Array.isArray(t)?(n.utf8(t[0]),void 0!==t[1]?n.u8_flags(t[1],w):n.u8(s)):(n.utf8(t.topic),void 0!==t.opts?n.u8_flags(t.opts,w):n.u8(s));return n.as_pkt(130)}},t=>(t=+t||t.mqtt_level,(e,n)=>N[e](t,n)));var N;const U=(I=x,T=P,M={mqtt_level:4},()=>{let t={__proto__:M};return t._base_=t,[I(t),T(t)]});var I,T,M;class C extends class extends class{constructor(t){this._conn_=function(t){const e=[];e.then=t=>{e.push(t)},e.notify=t=>{for(const n of e.splice(0,e.length))n(t)};const n=async(t,n)=>{(await e)(t,n)};return t._send=n,{is_live:()=>n!==t._send,reset(){t._send=n},set(n,s){const[r,o]=n(),i=async(t,e)=>{s(o(t,e))};return t._send=i,e.notify(i),e=>t._on_mqtt(r(e),t)}}}(this),t&&(this._on_mqtt=t,this._on_mqtt([],this))}auth(t){return this._send("auth",t)}connect(t){return this._send("connect",t)}disconnect(t){return this._send("disconnect",t)}subscribe(t){return this._send("subscribe",t)}unsubscribe(t){return this._send("unsubscribe",t)}publish(t){return this._send("publish",t)}_on_mqtt(t,e){}static with(t){return this.prototype.mqtt_session=t,this}}{async with_websock(t){null==t&&(t="ws://127.0.0.1:9001"),"string"==typeof t&&(t=new WebSocket(t,["mqtt"]));const{readyState:e}=t;if(t.binaryType="arraybuffer",1!==e){if(0!==e)throw new Error("Invalid WebSocket readyState");await new Promise(e=>t.addEventListener("open",e,{once:!0}))}const{_conn_:n}=this,s=n.set(this.mqtt_session,e=>t.send(e));return t.addEventListener("close",()=>{delete t.onmessage,n.reset()},{once:!0}),t.onmessage=t=>s(new Uint8Array(t.data)),this}}{}C.with(U);const L=new C((function(t,e){for(const e of t){const{type_obj:{type:t},u8_body:n,b0:s,id:r,cmd:o,...i}=e;console.log(`%c[mqtt ${t}]: %o`,"color: blue",i)}}));L.with_websock("ws://127.0.0.1:9001").then((async function(n){await async function(n){n.connect({client_id:`u8-mqtt-packet-demo [${e()}]`,flags:{clean_start:!0}}),await t(10),n.publish({topic:"u8-mqtt-packet/test-topic",payload:"awesome from node or web"})}(n),await t(10),n.disconnect()})),window.my_mqtt=L;
