function t(t,e=[]){do{const n=127&t;t>>>=7,e.push(n|(0===t?0:128))}while(t>0);return e}function e(t,e=0,n=[]){let s=(127&t[e])<<0;return 128&t[e++]&&(s|=(127&t[e])<<7,128&t[e++]&&(s|=(127&t[e])<<14,128&t[e++]&&(s|=(127&t[e])<<21))),n[0]=s,n[1]=e,n}const[n,s]=(()=>{const t=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qo_s"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]],e=new Map;for(const[n,s,r,o]of t){const t={id:n,type:s,name:r};o&&(t.plural=o),e.set(t.id,t),e.set(t.name,t)}return[e.get.bind(e),Array.from(e.values())]})();class r{constructor(t,e=0){this.buf=t,this.step=(t,n)=>(n=e,e+=t,n)}has_more(){const{buf:t,step:e}=this;return t.byteLength>e(0)}u8(){const{buf:t,step:e}=this;return t[e(1)]}u16(){const{buf:t,step:e}=this,n=e(2);return t[n]<<8|t[n+1]}u32(){const{buf:t,step:e}=this,n=e(4);return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}vint(){const{buf:t,step:n}=this,[s,r]=e(t,n(0));return n(r),s}bin(){const{buf:t,step:e}=this,n=e(2),s=t[n]<<8|t[n+1],r=e(s);return t.subarray(r,r+s)}utf8(){return new TextDecoder("utf-8").decode(this.bin())}pair(){return[this.utf8(),this.utf8()]}u8_flags(t){const{buf:e,step:n}=this;return new t(e[n(1)])}u8_reason(t){const{buf:e,step:n}=this;return t(e[n(1)])}flush(){const{buf:t,step:e}=this;return this.step=this.buf=null,t.subarray(e(0))}props(){const{buf:t,step:s}=this,[r,o]=e(t,s(0)),i=o+r;if(s(i),0===r)return null;const u=[],a=mqtt_reader(t.subarray(o,i));for(;a.has_more();){const{name:t,type:e}=n(a.u8()),s=a[e]();u.push([t,s])}return u}}class o extends Number{constructor(t,e){super(t),this.reason=e}}function i(t){const e=new Map;for(const[n,s]of t)e.set(n,new o(n,s));return e.get.bind(e)}class u extends Number{get reserved(){return!0&this}get clean_start(){return!0&this}get will_flag(){return!0&this}get will_qos(){return this>>>3&3}get will_retain(){return!0&this}get password(){return!0&this}get username(){return!0&this}}class a extends Number{get session_present(){return!0&this}}const c=i([[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"]]);const p=i([[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"]]);const l=i([[0,"Success"],[146,"Packet Identifier not found"]]);function _(t){const e=new r(t.u8_body,0);return t.pkt_id=e.u16(),t.reason=e.u8_reason(l),5<=t.mqtt_level&&(t.props=e.props()),t}class d extends Number{get qos(){return 3&this}get retain(){return!0&this}get retain_handling(){return this>>2&3}}const f=i([[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);function h(t,e,n){const s=new r(t.u8_body,0);t.pkt_id=s.u16(),5<=t.mqtt_level&&(t.props=s.props());const o=t[n]=[];for(;s.has_more();)o.push(s.u8_reason(e));return t}const b=i([[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"]]);const m=i([[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);const w=i([[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"]]);const v=t=>t,y=[function(t){const e=new Error("MQTT packet not understood");throw e.pkt=t,e},function(t){const e=new r(t.u8_body,0);if("MQTT"!==e.utf8())throw new Error("Invalid mqtt_connect packet");t._base_.mqtt_level=t.mqtt_level=e.u8();const n=t.connect_flags=e.u8_flags(u);t.keep_alive=e.u16(),5<=t.mqtt_level&&(t.props=e.props());const s=t.payload={};return s.client_id=e.utf8(),n.will_flag&&(5<=t.mqtt_level&&(s.will_properties=e.props()),s.will_topic=e.utf8(),s.will_payload=e.bin()),n.username&&(s.username=e.utf8()),n.password&&(s.password=e.bin()),t},function(t){const e=new r(t.u8_body,0);return t.connect_flags=e.u8_flags(a),t.reason=e.u8_reason(c),5<=t.mqtt_level&&(t.props=e.props()),t},function(t){const{hdr:e}=t;t.dup=Boolean(8&e),t.retain=Boolean(1&e);const n=t.qos=e>>1&3,s=new r(t.u8_body,0);return t.topic=s.utf8(),0!==n&&(t.pkt_id=s.u16()),5<=t.mqtt_level?(t.props=s.props(),t.payload=s.flush()):t.payload=s.flush(),t},function(t){const e=new r(t.u8_body,0);return t.pkt_id=e.u16(),5<=t.mqtt_level&&(t.reason=e.u8_reason(p),t.props=e.props()),t},_,_,_,function(t){const e=new r(t.u8_body,0);t.pkt_id=e.u16(),5<=t.mqtt_level&&(t.props=e.props());const n=t.sub_topics=[];for(;e.has_more();)n.push({topic:e.utf8(),opts:e.u8_flags(d)});return t},function(t){return h(t,f,"sub_answers")},function(t){const e=new r(t.u8_body,0);t.pkt_id=e.u16(),5<=t.mqtt_level&&(t.props=e.props());const n=t.unsub_topics=[];for(;e.has_more();)n.push(e.utf8());return t},function(t){return h(t,b,"unsub_answers")},v,v,function(t){if(5<=t.mqtt_level){const e=new r(t.u8_body,0);t.reason=e.u8_reason(m),t.props=e.props()}return t},function(t){if(5<=t.mqtt_level){const e=new r(t.u8_body,0);t.reason=e.u8_reason(w),t.props=e.props()}return t}];const g=t=>[t>>>8&255,255&t];class k{constructor(){Object.assign(this,this._pkt_writer())}u8(t){this.push([255&t])}u16(t){this.push(g(t))}u32(t){this.push((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])(t))}vint(e){this.push(t(e))}_u16_bin(t){const{push:e}=this;e(g(t.byteLength)),e(t)}flush(t){var e;this.push("string"==typeof t?(e=t,new TextEncoder("utf-8").encode(e)):t),this.push=!1}bin(t){if("string"==typeof t)return this.utf8(t);t.length!==t.byteLength&&(t=new Uint8Array(t)),this._u16_bin(t)}utf8(t){this._u16_bin(new TextEncoder("utf-8").encode(t))}pair(t,e){this.utf8(t),this.utf8(e)}u8_flags(t,e){return void 0!==t&&isNaN(+t)&&(t=e(t,0)),t|=0,this.push([t]),t}u8_reason(t){this.push([0|t])}props(){throw"TODO"}}k.prototype._pkt_writer=function(){const e=[];return()=>0===e.length?function(e){let n,s=0,r=[];return n={push(t){r.push(t),s+=t.length},as_pkt(o){const i=function(e,n,s){const r=t(n,[e]);let o=r.length;const i=new Uint8Array(n+o);i.set(r,0);for(const t of s)i.set(t,o),o+=t.length;return i}(o,s,r);return s=0,r=[],void 0!==e&&e.push(n),i}}}(e):e.pop()}();const q=new Uint8Array([0,4,77,81,84,84]);const S=t=>0|(t.reserved?1:0)|(3&t.will_qos)<<3|(t.clean_start?2:0)|(t.will_flag?4:0)|(t.will_retain?32:0)|(t.password?64:0)|(t.username?128:0);const x=t=>t.session_present?1:0;function N(t,e,n){const s=new k;return s.u16(n.pkt_id),5<=e?(s.props(n.props),s.u8_reason(n.reason)):s.u8_reason(n.return_code||n.reason),s.as_pkt(t)}const T=t=>0|3&t.qos|(t.retain?4:0)|(3&t.retain_handling)<<2;function A(t,e,n,s){const r=new k;r.u16(n.pkt_id),5<=n.mqtt_level&&r.props(n.props);for(const t of n[s])r.u8_reason(t);return r.as_pkt(t)}const P={connect:function(t,e){const n=new k;n.push(q),n.u8(t);const s=n.u8_flags(e.connect_flags,S);n.u16(e.keep_alive),5<=t&&n.props(e.props);const{payload:r}=e;return n.utf8(r.client_id),4&s&&(5<=t&&n.props(r.will_properties),n.utf8(r.will_topic),n.bin(r.will_payload)),128&s&&n.utf8(r.username),64&s&&n.bin(r.password),n.as_pkt(16)},connack:function(t,e){const n=new k;return n.u8_flags(e.connect_flags,x),5<=t?(n.u8_reason(e.reason),n.props(e.props)):n.u8_reason(e.return_code||e.reason),n.as_pkt(32)},publish:function(t,e){const n=(3&e.qos)<<1,s=new k;return s.utf8(e.topic),0!==n&&s.u16(e.pkt_id),5<=t?(s.props(e.props),s.flush(e.payload)):s.flush(e.payload),s.as_pkt(48|n|(e.dup?8:0)|(e.retain?1:0))},puback:function(t,e){const n=new k;return n.u16(e.pkt_id),5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(64)},pubrec:function(t,e){return N(80,t,e)},pubrel:function(t,e){return N(98,t,e)},pubcomp:function(t,e){return N(112,t,e)},subscribe:function(t,e){const n=new k;n.u16(e.pkt_id),5<=e.mqtt_level&&n.props(e.props);for(const t of e.sub_topics)"string"==typeof t?(n.utf8(t),n.u8(0)):Array.isArray(t)?(n.utf8(t[0]),n.u8_flags(t[1],T)):(n.utf8(t.topic),n.u8_flags(t.opts,T));return n.as_pkt(130)},suback:function(t,e){return A(144,t,e,"sub_answers")},unsubscribe:function(t,e){const n=new k;n.u16(e.pkt_id),5<=e.mqtt_level&&n.props(e.props);for(const t of e.unsub_topics)n.utf8(t);return n.as_pkt(162)},unsuback:function(t,e){return A(176,0,e,"unsub_answers")},pingreq:()=>new Uint8Array([192,0]),pingresp:()=>new Uint8Array([208,0]),disconnect:function(t,e){const n=new k;return 5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(224)},auth:function(t,e){if(5>t)throw new Error("Auth packets are only available after MQTT 5.x");const n=new k;return n.u8_reason(e.reason),n.props(e.props),n.as_pkt(240)}},[U,I]=(()=>{const t=[[0,"reserved"],[1,"connect"],[2,"connack"],[3,"publish"],[4,"puback"],[5,"pubrec"],[6,"pubrel"],[7,"pubcomp"],[8,"subscribe"],[9,"suback"],[10,"unsubscribe"],[11,"unsuback"],[12,"pingreq"],[13,"pingresp"],[14,"disconnect"],[15,"auth"]],e=new Map;for(const[n,s]of t){const t=n<<4;e.set(t,{type:s,cmd:t,id:n})}return[e.get.bind(e),Array.from(e.values())]})();function M(t,n){const[s]=t,[r,o]=e(s,1),i=r+o;if(s.byteLength>=i){const e=s[0],u=240&e,a=15&e;return t[0]=s.subarray(i),{__proto__:n,b0:e,cmd:u,hdr:a,type_obj:U(u),u8_body:0===r?null:s.subarray(o,i)}}}function Q(t){return(e={})=>{const n=[new Uint8Array(0)];return e._base_=e,s=>{n[0]=0===n[0].byteLength?s:function(t,e){const n=t.byteLength,s=new Uint8Array(n+e.byteLength);return s.set(t,0),s.set(e,n),s}(n[0],s);const r=[];for(;;){const s=M(n,e);if(void 0===s)return r;r.push(t(s))}}}}function C(t,e,n){return t=t||4,(s={mqtt_level:t})=>[e(s),n(s)]}const E=(L=y,Q(t=>{const e=L[t.type_obj.id];return void 0!==e?e.call(L,t):L[0](t)}));var L;const z=(B=P,t=>(t=+t||t.mqtt_level,(e,n)=>B[e](t,n)));var B;const j=C(4,E,z);C(5,E,z);var W,O=class{constructor(t){"function"==typeof t&&(this._on_mqtt=t)}_on_mqtt(t){}auth(t){this._send("auth",t)}connect(t){this._send("connect",t)}disconnect(t){this._send("disconnect",t)}publish(t){this._send("publish",t)}subscribe(t){this._send("subscribe",t)}unsubscribe(t){this._send("unsubscribe",t)}static with_api(t){class e extends(this){}return Object.assign(e.prototype,t),e}}.with_api((W=j,{async with_websock(t){"string"==typeof t&&(t=new WebSocket(t,["mqtt"]));const{readyState:e}=t;if(1!==e){if(0!==e)throw new Error("Invalid WebSocket readyState");await new Promise(e=>t.addEventListener("open",e,{once:!0}))}const[n,s]=W();return this._send=async(e,n)=>(t.send(s(e,n)),!0),t.onmessage=async({data:t})=>{const e=new Uint8Array(t instanceof ArrayBuffer?t:await t.arrayBuffer());this._on_mqtt(n(e))},this}}));function R(t){return{then(e){setTimeout(e,t)}}}(async()=>{const t=new O(t=>{for(const e of t){const{type_obj:t,u8_body:n,b0:s,cmd:r,...o}=e;console.log(`%c[mqtt ${t.type}]: %o`,"color: blue",o)}});await t.with_websock("ws://127.0.0.1:9001"),t.connect({connect_flags:{will_flag:1,will_qos:0},keep_alive:60,payload:{client_id:"swh_demo",will_topic:"swh/aaa/awesome",will_payload:"will is awesome"}}),await R(10),t.publish({topic:"swh/test-topic",payload:"awesome from web"}),await R(10),t.disconnect()})();
//# sourceMappingURL=web.min.mjs.map
