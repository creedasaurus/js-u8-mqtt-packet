function e(e,t=[]){do{const n=127&e;e>>>=7,t.push(n|(0===e?0:128))}while(e>0);return t}function t(e,t=0,n=[]){let s=(127&e[t])<<0;return 128&e[t++]&&(s|=(127&e[t])<<7,128&e[t++]&&(s|=(127&e[t])<<14,128&e[t++]&&(s|=(127&e[t])<<21))),n[0]=s,n[1]=t,n}const[n,s]=(()=>{const e=[[0,"reserved"],[1,"connect"],[2,"connack"],[3,"publish"],[4,"puback"],[5,"pubrec"],[6,"pubrel"],[7,"pubcomp"],[8,"subscribe"],[9,"suback"],[10,"unsubscribe"],[11,"unsuback"],[12,"pingreq"],[13,"pingresp"],[14,"disconnect"],[15,"auth"]],t=new Map;for(const[n,s]of e){const e=n<<4;t.set(e,{type:s,cmd:e,id:n})}return[t.get.bind(t),Array.from(t.values())]})();function o(e,s){const[o]=e,[r,i]=t(o,1),a=r+i;if(o.byteLength>=a){const t=o[0],u=240&t,c=15&t;return e[0]=o.subarray(a),{__proto__:s,b0:t,cmd:u,hdr:c,type_obj:n(u),u8_body:0===r?null:o.subarray(i,a)}}}function r(e){return(t={})=>{const n=[new Uint8Array(0)];return t._base_=t,s=>{n[0]=0===n[0].byteLength?s:function(e,t){const n=e.byteLength,s=new Uint8Array(n+t.byteLength);return s.set(e,0),s.set(t,n),s}(n[0],s);const r=[];for(;;){const s=o(n,t);if(void 0===s)return r;r.push(e(s))}}}}const[i,a]=(()=>{const e=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qo_s"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]],t=new Map;for(const[n,s,o,r]of e){const e={id:n,type:s,name:o};r&&(e.plural=r),t.set(e.id,e),t.set(e.name,e)}return[t.get.bind(t),Array.from(t.values())]})();class u{constructor(e,t=0){this.buf=e,this.step=(e,n)=>(n=t,t+=e,n)}has_more(){const{buf:e,step:t}=this;return e.byteLength>t(0)}u8(){const{buf:e,step:t}=this;return e[t(1)]}u16(){const{buf:e,step:t}=this,n=t(2);return e[n]<<8|e[n+1]}u32(){const{buf:e,step:t}=this,n=t(4);return e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3]}vint(){const{buf:e,step:n}=this,[s,o]=t(e,n(0));return n(o),s}bin(){const{buf:e,step:t}=this,n=t(2),s=e[n]<<8|e[n+1],o=t(s);return e.subarray(o,o+s)}utf8(){return new TextDecoder("utf-8").decode(this.bin())}pair(){return[this.utf8(),this.utf8()]}u8_flags(e){const{buf:t,step:n}=this;return new e(t[n(1)])}u8_reason(e){const{buf:t,step:n}=this;return e(t[n(1)])}flush(){const{buf:e,step:t}=this;return this.step=this.buf=null,e.subarray(t(0))}props(){const{buf:e,step:n}=this,[s,o]=t(e,n(0)),r=o+s;if(n(r),0===s)return null;const a=[],u=mqtt_reader(e.subarray(o,r));for(;u.has_more();){const{name:e,type:t}=i(u.u8()),n=u[t]();a.push([e,n])}return a}}class c extends Number{constructor(e,t){super(e),this.reason=t}}function p(e){const t=new Map;for(const[n,s]of e)t.set(n,new c(n,s));return t.get.bind(t)}class d extends Number{get session_present(){return!0&this}}const l=p([[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"]]);p([[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"]]),p([[0,"Success"],[146,"Packet Identifier not found"]]);const f=p([[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);p([[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"]]),p([[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]),p([[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"]]);const _=e=>[e>>>8&255,255&e];class h{constructor(){Object.assign(this,this._pkt_writer())}u8(e){this.push([255&e])}u16(e){this.push(_(e))}u32(e){this.push((e=>[e>>>24&255,e>>>16&255,e>>>8&255,255&e])(e))}vint(t){this.push(e(t))}_u16_bin(e){const{push:t}=this;t(_(e.byteLength)),t(e)}flush(e){var t;this.push("string"==typeof e?(t=e,new TextEncoder("utf-8").encode(t)):e),this.push=!1}bin(e){if("string"==typeof e)return this.utf8(e);e.length!==e.byteLength&&(e=new Uint8Array(e)),this._u16_bin(e)}utf8(e){this._u16_bin(new TextEncoder("utf-8").encode(e))}pair(e,t){this.utf8(e),this.utf8(t)}u8_flags(e,t){return void 0!==e&&isNaN(+e)&&(e=t(e,0)),e|=0,this.push([e]),e}u8_reason(e){this.push([0|e])}props(){throw"TODO"}}h.prototype._pkt_writer=function(){const t=[];return()=>0===t.length?function(t){let n,s=0,o=[];return n={push(e){o.push(e),s+=e.length},as_pkt(r){const i=function(t,n,s){const o=e(n,[t]);let r=o.length;const i=new Uint8Array(n+r);i.set(o,0);for(const e of s)i.set(e,r),r+=e.length;return i}(r,s,o);return s=0,o=[],void 0!==t&&t.push(n),i}}}(t):t.pop()}();const b=new Uint8Array([0,4,77,81,84,84]);const m=e=>0|(e.reserved?1:0)|(3&e.will_qos)<<3|(e.clean_start?2:0)|(e.will_flag?4:0)|(e.will_retain?32:0)|(e.password?64:0)|(e.username?128:0);const w=e=>0|3&e.qos|(e.retain?4:0)|(3&e.retain_handling)<<2;const y=Array(17).fill(e=>e);var v;var g;y[2]=function(e){const t=new u(e.u8_body,0);return e.connect_flags=t.u8_flags(d),e.reason=t.u8_reason(l),5<=e.mqtt_level&&(e.props=t.props()),e},y[3]=function(e){const{hdr:t}=e;e.dup=Boolean(8&t),e.retain=Boolean(1&t);const n=e.qos=t>>1&3,s=new u(e.u8_body,0);return e.topic=s.utf8(),0!==n&&(e.pkt_id=s.u16()),5<=e.mqtt_level?(e.props=s.props(),e.payload=s.flush()):e.payload=s.flush(),e},y[9]=function(e){return function(e,t,n){const s=new u(e.u8_body,0);e.pkt_id=s.u16(),5<=e.mqtt_level&&(e.props=s.props());const o=e[n]=[];for(;s.has_more();)o.push(s.u8_reason(t));return e}(e,f,"sub_answers")};const k=function(e,t,n){return e=e||4,(s={mqtt_level:e})=>[t(s),n(s)]}(4,(v=y,r(e=>{const t=v[e.type_obj.id];return void 0!==t?t.call(v,e):v[0](e)})),(g={connect:function(e,t){const n=new h;n.push(b),n.u8(e);const s=n.u8_flags(t.connect_flags,m);n.u16(t.keep_alive),5<=e&&n.props(t.props);const{payload:o}=t;return n.utf8(o.client_id),4&s&&(5<=e&&n.props(o.will_properties),n.utf8(o.will_topic),n.bin(o.will_payload)),128&s&&n.utf8(o.username),64&s&&n.bin(o.password),n.as_pkt(16)},disconnect:function(e,t){const n=new h;return 5<=e&&(n.u8_reason(t.reason),n.props(t.props)),n.as_pkt(224)},publish:function(e,t){const n=(3&t.qos)<<1,s=new h;return s.utf8(t.topic),0!==n&&s.u16(t.pkt_id),5<=e?(s.props(t.props),s.flush(t.payload)):s.flush(t.payload),s.as_pkt(48|n|(t.dup?8:0)|(t.retain?1:0))},subscribe:function(e,t){const n=new h;n.u16(t.pkt_id),5<=t.mqtt_level&&n.props(t.props);for(const e of t.sub_topics)"string"==typeof e?(n.utf8(e),n.u8(0)):Array.isArray(e)?(n.utf8(e[0]),n.u8_flags(e[1],w)):(n.utf8(e.topic),n.u8_flags(e.opts,w));return n.as_pkt(130)}},e=>(e=+e||e.mqtt_level,(t,n)=>g[t](e,n))));var S=class{constructor(e){"function"==typeof e&&(this._on_mqtt=e)}_on_mqtt(e){}auth(e){this._send("auth",e)}connect(e){this._send("connect",e)}disconnect(e){this._send("disconnect",e)}publish(e){this._send("publish",e)}subscribe(e){this._send("subscribe",e)}unsubscribe(e){this._send("unsubscribe",e)}static with_api(e){class t extends(this){}return Object.assign(t.prototype,e),t}}.with_api(function(e){return{async with_websock(t){"string"==typeof t&&(t=new WebSocket(t,["mqtt"]));const{readyState:n}=t;if(1!==n){if(0!==n)throw new Error("Invalid WebSocket readyState");await new Promise(e=>t.addEventListener("open",e,{once:!0}))}const[s,o]=e();return this._send=async(e,n)=>(t.send(o(e,n)),!0),t.onmessage=async({data:e})=>{const t=new Uint8Array(e instanceof ArrayBuffer?e:await e.arrayBuffer());this._on_mqtt(s(t))},this}}}(k));function x(e){return{then(t){setTimeout(t,e)}}}(async()=>{const e=new S(e=>{for(const t of e){const{type_obj:e,u8_body:n,b0:s,cmd:o,...r}=t;console.log(`%c[mqtt ${e.type}]: %o`,"color: blue",r)}});await e.with_websock("ws://127.0.0.1:9001"),e.connect({connect_flags:{will_flag:1,will_qos:0},keep_alive:60,payload:{client_id:"swh_demo",will_topic:"swh/aaa/awesome",will_payload:"will is awesome"}}),await x(10),e.publish({topic:"swh/test-topic",payload:"awesome from web"}),await x(10),e.disconnect()})();
//# sourceMappingURL=web_tiny.min.mjs.map
