function t(t,e=[]){do{const n=127&t;t>>>=7,e.push(n|(0===t?0:128))}while(t>0);return e}function e(t,e=0){let n=e,r=(127&t[e])<<0;return 128&t[e++]&&(r|=(127&t[e])<<7,128&t[e++]&&(r|=(127&t[e])<<14,128&t[e++]&&(r|=(127&t[e])<<21))),[r,e,n]}function n(t){let n=new Uint8Array(0);return r=>{n=0===n.byteLength?r:function(t,e){const n=t.byteLength,r=new Uint8Array(n+e.byteLength);return r.set(t,0),r.set(e,n),r}(n,r);const s=[];for(;;){const[r,i]=e(n,1),o=r+i;if(n.byteLength<o)return s;let u=n[0],a=0===r?null:n.subarray(i,o);n=n.subarray(o);const p=t(u,a);null!=p&&s.push(p)}}}const r=["~","connect","connack","publish","puback","pubrec","pubrel","pubcomp","subscribe","suback","unsubscribe","unsuback","pingreq","pingresp","disconnect","auth"];const s=new Map;{let t=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qos"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]];for(let[e,n,r,i]of t){let t={id:e,type:n,name:r};i&&(t.plural=i),s.set(t.id,t),s.set(t.name,t)}}const i=t=>new TextDecoder("utf-8").decode(t),o=t=>(e,n)=>(n=t,t+=e,n);class u{constructor(t,e=0){this.buf=t,this.step=o(e)}static with_info(...t){let e=class extends(this){};for(let n of t)n(e);return e}static reasons(t,...e){let n=this.prototype;n._reasons_by={...n._reasons_by};let r=n._reasons_by[t]||=new Map;for(let[t,n]of e)r.set(t,n);return this}has_more(){let{buf:t,step:e}=this;return t.byteLength>e(0)}u8(){let{buf:t,step:e}=this;return t[e(1)]}u16(){let{buf:t,step:e}=this,n=e(2);return t[n]<<8|t[n+1]}u32(){let{buf:t,step:e}=this,n=e(4);return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}vint(){let{buf:t,step:n}=this,[r,s,i]=e(t,n(0));return n(s-i),r}bin(){let{buf:t,step:e}=this,n=e(2),r=t[n]<<8|t[n+1],s=e(r);return t.subarray(s,s+r)}utf8(){return i(this.bin())}pair(){return[i(this.bin()),i(this.bin())]}u8_flags(t){let{buf:e,step:n}=this;return new t(e[n(1)])}u8_reason(t){let{buf:e,step:n}=this,r=e[n(1)];if(null!=r){let e=this._reasons_by[t]?.get(r);return new a(r,e||t)}}flush(){let{buf:t,step:e}=this;return this.step=this.buf=null,t.subarray(e(0))}}class a extends Number{constructor(t,e){super(t),this.reason=e}}function p(){let e=[];return n=>0===e.length?function(e,n){let r=0,s=[];return i(e);function i(t){(e=t).push=o,e.pack=u}function o(t){s.push(t),r+=t.length}function u(o){e=e.push=e.pack=null;let u=function(e,n,r){let s=t(n,e),i=s.length,o=new Uint8Array(n+i);o.set(s,0);for(let t of r)o.set(t,i),i+=t.length;return o}(o,r,s);return r=0,s=[],void 0!==n&&n.push(i),u}}(n,e):e.pop()(n)}class c{constructor(){this._pkt_writer(this)}static init(){let t=class extends(this){};return t.prototype._pkt_writer=p(),t}as_pkt(t){return this.pack([t])}u8(t){this.push([255&t])}u16(t){this.push([t>>>8&255,255&t])}u32(t){this.push([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}vint(e){this.push(t(e))}_u16_bin(t){this.u16(t.byteLength),this.push(t)}flush(t){null!=t&&this.push("string"==typeof t?new TextEncoder("utf-8").encode(t):t),this.push=!1}bin(t){return t?"string"==typeof t?this.utf8(t):(t.length!==t.byteLength&&(t=new Uint8Array(t)),void this._u16_bin(t)):this.u16(0)}utf8(t){this._u16_bin(new TextEncoder("utf-8").encode(t))}pair(t,e){this.utf8(t),this.utf8(e)}u8_flags(t,e,n=0){return void 0!==t&&isNaN(+t)&&(t=e(t,0)),t|=n,this.push([t]),t}u8_reason(t){this.push([0|t])}}function l(t){t.reasons("connack",[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"])}function _(t){t.reasons("puback",[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"])}function f(t){t.reasons("pubxxx",[0,"Success"],[146,"Packet Identifier not found"])}function d(t){return(e,n)=>{let r=new t(n,0);e.pkt_id=r.u16(),5<=e.mqtt_level&&(e.props=r.props());let s=e.answers=[];for(;r.has_more();)s.push(r.u8_reason(e.type));return e}}function h(t){!function(t){t.reasons("suback",[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"])}(t),t.reasons("suback",[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function b(t){t.reasons("unsuback",[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"])}function m(t){t.reasons("disconnect",[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"])}function w(t){t.reasons("auth",[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"])}const y=new Uint8Array([0,4,77,81,84,84]);const g=class extends u{props(){let t=this.vbuf();return null===t?null:this._fork(t,0)._read_props([])}vbuf(){let{buf:t,step:n}=this,[r,s,i]=e(t,n(0));return n(r+s-i),0===r?null:t.subarray(s,n(0))}_fork(t,e){return{__proto__:this,buf:t,step:o(e)}}_read_props(t){for(;this.has_more();){let e=this.u8(),n=s.get(e),r=this[n.type]();t.push([n.name,r])}return t}}.with_info(l,_,f,h,b,m,w),v=class extends c{props(t){if(!t)return this.u8(0);if(Array.isArray(t)||(t=t.entries?Array.from(t.entries()):Object.entries(t)),0===t.length)return this.u8(0);let e=this._fork();for(let[n,r]of t){let{id:t,type:i}=s.get(n);e.u8(t),e[i](r)}this.push(e.pack([]))}_fork(){let t={__proto__:this};return this._pkt_writer(t),t}}.init(),k=[function(t,e){class n extends Number{get reserved(){return!0&this}get clean_start(){return!0&this}get will_flag(){return!0&this}get will_qos(){return this>>>3&3}get will_retain(){return!0&this}get password(){return!0&this}get username(){return!0&this}}return t[1]=(t,r)=>{let s=new e(r,0);if("MQTT"!==s.utf8())throw new Error("Invalid mqtt_connect packet");t._base_.mqtt_level=t.mqtt_level=s.u8();let i=t.flags=s.u8_flags(n);if(t.keep_alive=s.u16(),5<=t.mqtt_level&&(t.props=s.props()),t.client_id=s.utf8(),i.will_flag){let e=t.will={};5<=t.mqtt_level&&(e.props=s.props()),e.topic=s.utf8(),e.payload=s.bin(),e.qos=i.will_qos,e.retain=i.will_retain}return i.username&&(t.username=s.utf8()),i.password&&(t.password=s.bin()),t}},function(t,e){class n extends Number{get session_present(){return!0&this}}return t[2]=(t,r)=>{let s=new e(r,0);return t.flags=s.u8_flags(n),t.reason=s.u8_reason(t.type),5<=t.mqtt_level&&(t.props=s.props()),t}},function(t,e){return t[3]=(t,n)=>{let{hdr:r}=t;t.dup=Boolean(8&r),t.retain=Boolean(1&r);let s=t.qos=r>>1&3,i=new e(n,0);return t.topic=i.utf8(),0!==s&&(t.pkt_id=i.u16()),5<=t.mqtt_level&&(t.props=i.props()),t.payload=i.flush(),t}},function(t,e){return t[4]=(t,n)=>{let r=new e(n,0);return t.pkt_id=r.u16(),5<=t.mqtt_level&&(t.reason=r.u8_reason(t.type),t.props=r.props()),t}},function(t,e){return t[5]=t[6]=t[7]=(t,n)=>{let r=new e(n,0);return t.pkt_id=r.u16(),t.reason=r.u8_reason("pubxxx",e),5<=t.mqtt_level&&(t.props=r.props()),t}},function(t,e){class n extends Number{get qos(){return 3&this}get retain(){return!0&this}get retain_handling(){return this>>2&3}}return t[8]=(t,r)=>{let s=new e(r,0);t.pkt_id=s.u16(),5<=t.mqtt_level&&(t.props=s.props());let i=t.topics=[];for(;s.has_more();){let t=s.utf8(),e=s.u8_flags(n);i.push({topic:t,opts:e})}return t}},function(t,e){return t[9]=d(e)},function(t,e){return t[10]=(t,n)=>{let r=new e(n,0);t.pkt_id=r.u16(),5<=t.mqtt_level&&(t.props=r.props());let s=t.topics=[];for(;r.has_more();)s.push(r.utf8());return t}},function(t,e){return t[11]=d(e)},function(t){return t[12]=t[13]=t=>t},function(t,e){return t[14]=(t,n)=>{if(n&&5<=t.mqtt_level){let r=new e(n,0);t.reason=r.u8_reason(t.type),t.props=r.props()}return t}},function(t,e){return t[15]=(t,n)=>{if(5<=t.mqtt_level){let r=new e(n,0);t.reason=r.u8_reason(t.type),t.props=r.props()}return t}}],q=[function(t,e){const n=t=>0|(t.reserved?1:0)|(3&t.will_qos)<<3|(t.clean_start?2:0)|(t.will_flag?4:0)|(t.will_retain?32:0)|(t.password?64:0)|(t.username?128:0);return t.connect=(t,r)=>{let s=new e;s.push(y),s.u8(t);let{will:i,username:o,password:u}=r,a=s.u8_flags(r.flags,n,0|(o?128:0)|(u?64:0)|(i?(t=>4|(3&t.qos)<<3|(t.retain?32:0))(i):0));return s.u16(r.keep_alive),5<=t&&s.props(r.props),s.utf8(r.client_id),4&a&&(5<=t&&s.props(i.props),s.utf8(i.topic),s.bin(i.payload)),128&a&&s.utf8(o),64&a&&s.bin(u),s.as_pkt(16)}},function(t,e){const n=t=>t.session_present?1:0;return t.connack=(t,r)=>{let s=new e;return s.u8_flags(r.flags,n),5<=t?(s.u8_reason(r.reason),s.props(r.props)):s.u8_reason(r.return_code||r.reason),s.as_pkt(32)}},function(t,e){return t.publish=(t,n)=>{let r=(3&n.qos)<<1,s=new e;return s.utf8(n.topic),0!==r&&s.u16(n.pkt_id),5<=t?(s.props(n.props),s.flush(n.payload)):s.flush(n.payload),s.as_pkt(48|r|(n.dup?8:0)|(n.retain?1:0))}},function(t,e){return t.puback=(t,n)=>{let r=new e;return r.u16(n.pkt_id),5<=t&&(r.u8_reason(n.reason),r.props(n.props)),r.as_pkt(64)}},function(t,e){function n(t){return(n,r)=>{let s=new e;return s.u16(r.pkt_id),5<=n?(s.props(r.props),s.u8_reason(r.reason)):s.u8_reason(r.return_code||r.reason),s.as_pkt(t)}}t.pubrec=n(80),t.pubrel=n(98),t.pubcomp=n(112)},function(t,e){const n=t=>0|3&t.qos|(t.retain?4:0)|(3&t.retain_handling)<<2;return t.subscribe=(t,r)=>{let s=new e;s.u16(r.pkt_id),5<=t&&s.props(r.props);let i=n(r);for(let t of r.topics)if("string"==typeof t)s.utf8(t),s.u8(i);else{let[e,r]=Array.isArray(t)?t:[t.topic,t.opts];s.utf8(e),void 0===r?s.u8(i):s.u8_flags(r,n)}return s.as_pkt(130)}},function(t,e){function n(t){return(n,r)=>{let s=new e;s.u16(r.pkt_id),5<=n&&s.props(r.props);for(let t of r.answers)s.u8_reason(t);return s.as_pkt(t)}}t.suback=n(144),t.unsuback=n(176)},function(t,e){return t.unsubscribe=(t,n)=>{let r=new e;r.u16(n.pkt_id),5<=t&&r.props(n.props);for(let t of n.topics)r.utf8(t);return r.as_pkt(162)}},function(t,e){t.pingreq=()=>new Uint8Array([192,0]),t.pingresp=()=>new Uint8Array([208,0])},function(t,e){return t.disconnect=(t,n)=>{let r=new e;return n&&5<=t&&(n.reason||n.props)&&(r.u8_reason(n.reason),r.props(n.props)),r.as_pkt(224)}},function(t,e){return t.auth=(t,n)=>{if(5>t)throw new Error("Auth packets are only available after MQTT 5.x");let r=new e;return r.u8_reason(n.reason),r.props(n.props),r.as_pkt(240)}}];function x(t){let{ctx:e}=x;return void 0===e&&(x.ctx=e=function(t){let e,s=Object.defineProperties(t._pkt_ctx_||{},{hdr:{get(){return 15&this.b0}},id:{get(){return this.b0>>>4}},type:{get(){return r[this.b0>>>4]}}}),i=[],o={};for(e of t.encode_fns)e(o,t.mqtt_writer);for(e of t.decode_fns)e(i,t.mqtt_reader);var u=({mqtt_level:t})=>(e,n)=>o[e](t,n),a=t=>n(((e,n,r)=>(i[e>>>4]||i[0])?.({__proto__:t,b0:e},n)));return t=>e=>[a(e=e||{__proto__:s,mqtt_level:t,get _base_(){return e}}),u(e),e]}({decode_fns:k,mqtt_reader:g,encode_fns:q,mqtt_writer:v})),e(t)}function S(t){const e=A(),n=A(),r=async(t,e)=>(await n)(t,e);let s=t._send=r;return{is_live:()=>r!==s,reset(){t._send=s=r},async send_connect(...i){r===s&&(s=await e);let o=s(...i);return await null,t._send=s,n.notify(s),o},set(n,r){const[i,o]=n;return s=async(t,e)=>r(o(t,e)),e.notify(s),async function(t,e){void 0!==e&&await e.call(t,await t)}(t,t.on_live),e=>t.on_mqtt(i(e),{mqtt:t})}}}function A(){const t=[];return t.then=e=>{t.push(e)},t.notify=e=>{for(const n of t.splice(0,t.length))n(e)},t}class N{constructor(t={}){"function"==typeof t&&(t={on_mqtt:t});const{on_mqtt:e,on_live:n}=t;e&&(this.on_mqtt=e),n&&(this.on_live=n),this._conn_=S(this),this.on_mqtt([],{mqtt:this})}auth(t){return this._send("auth",t)}connect(t){return this._conn_.send_connect("connect",t)}disconnect(t){return this._send("disconnect",t)}ping(){return this._send("pingreq")}subscribe(t){return this._send("subscribe",t)}unsubscribe(t){return this._send("unsubscribe",t)}puback(t){return this._send("puback",t)}publish(t){return this._send("publish",t)}on_mqtt(){}on_live(){}with_async_iter(t,e){const{_conn_:n}=this,r=n.set(this._mqtt_session(),e);return this._msg_loop=(async()=>{t=await t;for await(let e of t)r(e);this._conn_.reset()})(),this}static with(t){return this.prototype._mqtt_session=t,this}}class T extends N{with_websock(t){null==t&&(t="ws://127.0.0.1:9001"),("string"==typeof t||t.origin)&&(t=new WebSocket(new URL(t),["mqtt"])),t.binaryType="arraybuffer";let e=!0,{readyState:n}=t;if(1!==n){if(0!==n)throw new Error("Invalid WebSocket readyState");e=new Promise((e=>t.addEventListener("open",e,{once:!0})))}const{_conn_:r}=this,s=r.set(this._mqtt_session(),(async n=>(await e,t.send(n))));return t.addEventListener("close",(()=>{delete t.onmessage,r.reset()}),{once:!0}),t.onmessage=t=>s(new Uint8Array(t.data)),this}}class U extends T{_mqtt_session(){return x(4)()}}class I extends T{_mqtt_session(){return x(5)()}}export{U as MQTTBonesWeb_v4,I as MQTTBonesWeb_v5,U as default};
