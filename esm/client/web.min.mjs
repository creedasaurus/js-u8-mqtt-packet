function t(t,e=[]){do{const n=127&t;t>>>=7,e.push(n|(0===t?0:128))}while(t>0);return e}function e(t,e=0){let n=(127&t[e])<<0;return 128&t[e++]&&(n|=(127&t[e])<<7,128&t[e++]&&(n|=(127&t[e])<<14,128&t[e++]&&(n|=(127&t[e])<<21))),[n,e]}function n(t){const[n]=t,[r,s]=e(n,1),o=r+s;if(n.byteLength<o)return t.length=1,!0;t[0]=n.subarray(o),t[1]=n[0],t[2]=0===r?null:n.subarray(s,o)}function r(t){const e=[new Uint8Array(0)];return r=>{e[0]=0===e[0].byteLength?r:function(t,e){const n=t.byteLength,r=new Uint8Array(n+e.byteLength);return r.set(t,0),r.set(e,n),r}(e[0],r);const s=[];for(;;){if(n(e))return s;const r=t(e[1],e[2]);null!=r&&s.push(r)}}}const s=new Map;{const t=[[1,"u8","payload_format_indicator"],[2,"u32","message_expiry_interval"],[3,"utf8","content_type"],[8,"utf8","response_topic"],[9,"bin","correlation_data"],[11,"vint","subscription_identifier"],[17,"u32","session_expiry_interval"],[18,"utf8","assigned_client_identifier"],[19,"u16","server_keep_alive"],[21,"utf8","authentication_method"],[22,"bin","authentication_data"],[23,"u8","request_problem_information"],[24,"u32","will_delay_interval"],[25,"u8","request_response_information"],[26,"utf8","response_information"],[28,"utf8","server_reference"],[31,"utf8","reason_string"],[33,"u16","receive_maximum"],[34,"u16","topic_alias_maximum"],[35,"u16","topic_alias"],[36,"u8","maximum_qo_s"],[37,"u8","retain_available"],[38,"pair","user_properties",!0],[39,"u32","maximum_packet_size"],[40,"u8","wildcard_subscription_available"],[41,"u8","subscription_identifiers_available",!0],[42,"u8","shared_subscription_available"]];for(const[e,n,r,o]of t){const t={id:e,type:n,name:r};o&&(t.plural=o),s.set(t.id,t),s.set(t.name,t)}}const o=t=>new TextDecoder("utf-8").decode(t),i=t=>(e,n)=>(n=t,t+=e,n);class u{constructor(t,e=0){this.buf=t,this.step=i(e)}_fork(t,e){return{__proto__:this,buf:t,step:i(e)}}has_more(){const{buf:t,step:e}=this;return t.byteLength>e(0)}u8(){const{buf:t,step:e}=this;return t[e(1)]}u16(){const{buf:t,step:e}=this,n=e(2);return t[n]<<8|t[n+1]}u32(){const{buf:t,step:e}=this,n=e(4);return t[n]<<24|t[n+1]<<16|t[n+2]<<8|t[n+3]}vint(){const{buf:t,step:n}=this,[r,s]=e(t,n(0));return n(s),r}bin(){const{buf:t,step:e}=this,n=e(2),r=t[n]<<8|t[n+1],s=e(r);return t.subarray(s,s+r)}utf8(){return o(this.bin())}pair(){return[o(this.bin()),o(this.bin())]}u8_flags(t){const{buf:e,step:n}=this;return new t(e[n(1)])}u8_reason(t){const{buf:e,step:n}=this;return t(e[n(1)])}flush(){const{buf:t,step:e}=this;return this.step=this.buf=null,t.subarray(e(0))}props(){const{buf:t,step:n}=this,[r,o]=e(t,n(0)),i=o+r;if(n(i),0===r)return null;const u=[],a=this._fork(t.subarray(o,i));for(;a.has_more();){const{name:t,type:e}=s.get(a.u8()),n=a[e]();u.push([t,n])}return u}}class a extends Number{constructor(t,e){super(t),this.reason=e}}function c(t){const e=new Map;for(const[n,r]of t)e.set(n,new a(n,r));return e.get.bind(e)}function p(t){class e extends Number{get reserved(){return!0&this}get clean_start(){return!0&this}get will_flag(){return!0&this}get will_qos(){return this>>>3&3}get will_retain(){return!0&this}get password(){return!0&this}get username(){return!0&this}}return t[1]=(t,n)=>{const r=new u(n,0);if("MQTT"!==r.utf8())throw new Error("Invalid mqtt_connect packet");t._base_.mqtt_level=t.mqtt_level=r.u8();const s=t.flags=r.u8_flags(e);if(t.keep_alive=r.u16(),5<=t.mqtt_level&&(t.props=r.props()),t.client_id=r.utf8(),s.will_flag){const e=t.will={};5<=t.mqtt_level&&(e.props=r.props()),e.topic=r.utf8(),e.payload=r.bin(),e.qos=s.will_qos,e.retain=s.will_retain}return s.username&&(t.username=r.utf8()),s.password&&(t.password=r.bin()),t}}function l(t){class e extends Number{get session_present(){return!0&this}}const n=c([[0,"Success"],[1,"Connection refused, unacceptable protocol version"],[2,"Connection refused, identifier rejected"],[3,"Connection refused, server unavailable"],[4,"Connection refused, bad user name or password"],[5,"Connection refused, not authorized"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[132,"Unsupported Protocol Version"],[133,"Client Identifier not valid"],[134,"Bad User Name or Password"],[135,"Not authorized"],[136,"Server unavailable"],[137,"Server busy"],[138,"Banned"],[140,"Bad authentication method"],[144,"Topic Name invalid"],[149,"Packet too large"],[151,"Quota exceeded"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[159,"Connection rate exceeded"]]);return t[2]=(t,r)=>{const s=new u(r,0);t.flags=s.u8_flags(e);return t.reason=s.u8_reason(n),5<=t.mqtt_level&&(t.props=s.props()),t}}function f(t){return t[3]=(t,e)=>{const{hdr:n}=t;t.dup=Boolean(8&n),t.retain=Boolean(1&n);const r=t.qos=n>>1&3,s=new u(e,0);return t.topic=s.utf8(),0!==r&&(t.pkt_id=s.u16()),5<=t.mqtt_level?(t.props=s.props(),t.payload=s.flush()):t.payload=s.flush(),t}}function d(t){const e=c([[0,"Success"],[16,"No matching subscribers"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[144,"Topic Name invalid"],[145,"Packet identifier in use"],[151,"Quota exceeded"],[153,"Payload format invalid"]]);return t[4]=(t,n)=>{const r=new u(n,0);return t.pkt_id=r.u16(),5<=t.mqtt_level&&(t.reason=r.u8_reason(e),t.props=r.props()),t}}function _(t){const e=c([[0,"Success"],[146,"Packet Identifier not found"]]);return t[5]=t[6]=t[7]=(t,n)=>{const r=new u(n,0);return t.pkt_id=r.u16(),t.reason=r.u8_reason(e),5<=t.mqtt_level&&(t.props=r.props()),t}}function h(t){class e extends Number{get qos(){return 3&this}get retain(){return!0&this}get retain_handling(){return this>>2&3}}return t[8]=(t,n)=>{const r=new u(n,0);t.pkt_id=r.u16(),5<=t.mqtt_level&&(t.props=r.props());const s=t.topics=[];for(;r.has_more();)s.push({topic:r.utf8(),opts:r.u8_flags(e)});return t}}function b(t){return(e,n)=>{const r=new u(n,0);e.pkt_id=r.u16(),5<=e.mqtt_level&&(e.props=r.props());const s=e.answers=[];for(;r.has_more();)s.push(r.u8_reason(t));return e}}function m(t){const e=c([[0,"Granted QoS 0"],[1,"Granted QoS 1"],[2,"Granted QoS 2"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"],[151,"Quota exceeded"],[158,"Shared Subscriptions not supported"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);return t[9]=b(e)}function v(t){return t[10]=(t,e)=>{const n=new u(e,0);t.pkt_id=n.u16(),5<=t.mqtt_level&&(t.props=n.props());const r=t.topics=[];for(;n.has_more();)r.push(n.utf8());return t}}function w(t){const e=c([[0,"Success"],[17,"No subscription existed"],[128,"Unspecified error"],[131,"Implementation specific error"],[135,"Not authorized"],[143,"Topic Filter invalid"],[145,"Packet Identifier in use"]]);return t[11]=b(e)}function g(t){return t[12]=t[13]=t=>t}function y(t){const e=c([[0,"Normal disconnection"],[4,"Disconnect with Will Message"],[128,"Unspecified error"],[129,"Malformed Packet"],[130,"Protocol Error"],[131,"Implementation specific error"],[135,"Not authorized"],[137,"Server busy"],[139,"Server shutting down"],[141,"Keep Alive timeout"],[142,"Session taken over"],[143,"Topic Filter invalid"],[144,"Topic Name invalid"],[147,"Receive Maximum exceeded"],[148,"Topic Alias invalid"],[149,"Packet too large"],[150,"Message rate too high"],[151,"Quota exceeded"],[152,"Administrative action"],[153,"Payload format invalid"],[154,"Retain not supported"],[155,"QoS not supported"],[156,"Use another server"],[157,"Server moved"],[158,"Shared Subscriptions not supported"],[159,"Connection rate exceeded"],[160,"Maximum connect time"],[161,"Subscription Identifiers not supported"],[162,"Wildcard Subscriptions not supported"]]);return t[14]=(t,n)=>{if(5<=t.mqtt_level){const r=new u(n,0);t.reason=r.u8_reason(e),t.props=r.props()}return t}}function k(t){const e=c([[0,"Success"],[24,"Continue authentication"],[25,"Re-authenticate"]]);return t[15]=(t,n)=>{if(5<=t.mqtt_level){const r=new u(n,0);t.reason=r.u8_reason(e),t.props=r.props()}return t}}const q=t=>[t>>>8&255,255&t];class x{constructor(){this._pkt_writer(this)}as_pkt(t){return this.pack([t])}u8(t){this.push([255&t])}u16(t){this.push(q(t))}u32(t){this.push((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])(t))}vint(e){this.push(t(e))}_u16_bin(t){const{push:e}=this;e(q(t.byteLength)),e(t)}flush(t){var e;null!=t&&this.push("string"==typeof t?(e=t,new TextEncoder("utf-8").encode(e)):t),this.push=!1}bin(t){return t?"string"==typeof t?this.utf8(t):(t.length!==t.byteLength&&(t=new Uint8Array(t)),void this._u16_bin(t)):this.u16(0)}utf8(t){this._u16_bin(new TextEncoder("utf-8").encode(t))}pair(t,e){this.utf8(t),this.utf8(e)}u8_flags(t,e,n=0){return void 0!==t&&isNaN(+t)&&(t=e(t,0)),t|=n,this.push([t]),t}u8_reason(t){this.push([0|t])}props(t){if(!t)return this.u8(0);Array.isArray(t)||(t=t.entries?Array.from(t.entries()):Object.entries(t));const e=this._fork();for(const[n,r]of t){const{id:t,type:o}=s.get(n);e.u8(t),e[o](r)}this.push(e.pack([]))}}x.prototype._pkt_writer=function(){const e=[];return n=>0===e.length?function(e,n){let r=0,s=[];return o(e);function o(t){(e=t).push=i,e.pack=u}function i(t){s.push(t),r+=t.length}function u(i){e=e.push=e.pack=null;const u=function(e,n,r){const s=t(n,e);let o=s.length;const i=new Uint8Array(n+o);i.set(s,0);for(const t of r)i.set(t,o),o+=t.length;return i}(i,r,s);return r=0,s=[],void 0!==n&&n.push(o),u}}(n,e):e.pop()(n)}();const S=new Uint8Array([0,4,77,81,84,84]);function N(t){const e=t=>0|(t.reserved?1:0)|(3&t.will_qos)<<3|(t.clean_start?2:0)|(t.will_flag?4:0)|(t.will_retain?32:0)|(t.password?64:0)|(t.username?128:0);return t.connect=(t,n)=>{const r=new x;r.push(S),r.u8(t);const{will:s,username:o,password:i}=n,u=r.u8_flags(n.flags,e,0|(o?128:0)|(i?64:0)|(s?(t=>4|(3&t.qos)<<3|(t.retain?32:0))(s):0));return r.u16(n.keep_alive),5<=t&&r.props(n.props),r.utf8(n.client_id),4&u&&(5<=t&&r.props(s.props),r.utf8(s.topic),r.bin(s.payload)),128&u&&r.utf8(o),64&u&&r.bin(i),r.as_pkt(16)}}function A(t){const e=t=>t.session_present?1:0;return t.connack=(t,n)=>{const r=new x;return r.u8_flags(n.flags,e),5<=t?(r.u8_reason(n.reason),r.props(n.props)):r.u8_reason(n.return_code||n.reason),r.as_pkt(32)}}function P(t){return t.publish=(t,e)=>{const n=(3&e.qos)<<1,r=new x;return r.utf8(e.topic),0!==n&&r.u16(e.pkt_id),5<=t?(r.props(e.props),r.flush(e.payload)):r.flush(e.payload),r.as_pkt(48|n|(e.dup?8:0)|(e.retain?1:0))}}function U(t){return t.puback=(t,e)=>{const n=new x;return n.u16(e.pkt_id),5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(64)}}function T(t){function e(t){return(e,n)=>{const r=new x;return r.u16(n.pkt_id),5<=e?(r.props(n.props),r.u8_reason(n.reason)):r.u8_reason(n.return_code||n.reason),r.as_pkt(t)}}t.pubrec=e(80),t.pubrel=e(98),t.pubcomp=e(112)}function I(t){const e=t=>0|3&t.qos|(t.retain?4:0)|(3&t.retain_handling)<<2;return t.subscribe=(t,n)=>{const r=new x;r.u16(n.pkt_id),5<=n.mqtt_level&&r.props(n.props);const s=e(n);for(const t of n.topics)"string"==typeof t?(r.utf8(t),r.u8(s)):Array.isArray(t)?(r.utf8(t[0]),void 0!==t[1]?r.u8_flags(t[1],e):r.u8(s)):(r.utf8(t.topic),void 0!==t.opts?r.u8_flags(t.opts,e):r.u8(s));return r.as_pkt(130)}}function Q(t){function e(t){return(e,n)=>{const r=new x;r.u16(n.pkt_id),5<=n.mqtt_level&&r.props(n.props);for(const t of n.answers)r.u8_reason(t);return r.as_pkt(t)}}t.suback=e(144),t.unsuback=e(176)}function L(t){return t.unsubscribe=(t,e)=>{const n=new x;n.u16(e.pkt_id),5<=e.mqtt_level&&n.props(e.props);for(const t of e.topics)n.utf8(t);return n.as_pkt(162)}}function M(t){t.pingreq=()=>new Uint8Array([192,0]),t.pingresp=()=>new Uint8Array([208,0])}function C(t){return t.disconnect=(t,e)=>{const n=new x;return 5<=t&&(n.u8_reason(e.reason),n.props(e.props)),n.as_pkt(224)}}function E(t){return t.auth=(t,e)=>{if(5>t)throw new Error("Auth packets are only available after MQTT 5.x");const n=new x;return n.u8_reason(e.reason),n.props(e.props),n.as_pkt(240)}}const z=t=>t[0]=t=>t;const B=["reserved","connect","connack","publish","puback","pubrec","pubrel","pubcomp","subscribe","suback","unsubscribe","unsuback","pingreq","pingresp","disconnect","auth"],R=t=>Object.defineProperties(t||{},{hdr:{get(){return 15&this.b0}},id:{get(){return this.b0>>>4}},type:{get(){return B[this.b0>>>4]}}});function W(t,e,n){return t=function(t){const e=[];for(const n of t)n(e);return t=>r((n,r)=>{const s=e[n>>>4]||e[0];if(void 0!==s)return s({__proto__:t,b0:n},r)})}(t),e=function(t){const e={};for(const n of t)n(e);return({mqtt_level:t})=>(n,r)=>e[n](t,r)}(e),n=R(n),r=>()=>{let s={__proto__:n,mqtt_level:r,get _base_(){return s}};return[t(s),e(s)]}}function j(t){let{ctx:e}=j;return void 0===e&&(j.ctx=e=W([z,p,l,f,d,_,h,m,v,w,g,y,k],[N,A,P,U,T,I,Q,L,M,C,E])),e(t)}class F extends class{constructor(t){this._conn_=function(t){const e=[];e.then=t=>{e.push(t)},e.notify=t=>{for(const n of e.splice(0,e.length))n(t)};const n=async(t,n)=>(await e)(t,n);return t._send=n,{is_live:()=>n!==t._send,reset(){t._send=n},set(n,r){const[s,o]=n(),i={mqtt:t},u=async(t,e)=>r(o(t,e));return t._send=u,e.notify(u),e=>t.on_mqtt(s(e),i)}}}(this),t&&(this.on_mqtt=t,this.on_mqtt([],{mqtt:this}))}auth(t){return this._send("auth",t)}connect(t){return this._send("connect",t)}disconnect(t){return this._send("disconnect",t)}ping(){return this._send("pingreq")}subscribe(t){return this._send("subscribe",t)}unsubscribe(t){return this._send("unsubscribe",t)}puback(t){return this._send("puback",t)}publish(t){return this._send("publish",t)}on_mqtt(){}static with(t){return this.prototype.mqtt_session=t,this}}{async with_websock(t){null==t&&(t="ws://127.0.0.1:9001"),("string"==typeof t||t.origin)&&(t=new WebSocket(new URL(t),["mqtt"]));const{readyState:e}=t;if(t.binaryType="arraybuffer",1!==e){if(0!==e)throw new Error("Invalid WebSocket readyState");await new Promise(e=>t.addEventListener("open",e,{once:!0}))}const{_conn_:n}=this,r=n.set(this.mqtt_session,e=>t.send(e));return t.addEventListener("close",()=>{delete t.onmessage,n.reset()},{once:!0}),t.onmessage=t=>r(new Uint8Array(t.data)),this}}class G extends F{}class D extends F{}G.with(j(4)),D.with(j(5));export default G;export{G as MQTTBonesWeb_v4,D as MQTTBonesWeb_v5};
//# sourceMappingURL=web.min.mjs.map
